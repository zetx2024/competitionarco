<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IARCO 2025 Certificate Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;700&family=Times+New+Roman&display=swap" rel="stylesheet">
<style>
    body {
        font-family: "Playfair Display", serif;
        background: linear-gradient(to right, #e3e7ff, #fff9e6);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    h1 {
        margin-top: 20px;
        color: #003366;
        font-size: 32px;
        letter-spacing: 1px;
    }
    .search-box {
        margin: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    input {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 280px;
        font-size: 16px;
    }
    button {
        background: #004aad;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
    }
    button:hover {
        background: #002f6c;
    }
    .loading {
        margin-top: 10px;
        font-style: italic;
        color: #888;
        display: none;
    }

    /* Certificate layout container */
    #certificate {
        position: relative;
        width: 2480px;
        height: 3508px;
        background: white;
        overflow: hidden;
        display: none;
    }
    #certificate canvas, #certificate img {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }

    .overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        text-align: center;
        color: #000;
    }

    .student-name {
        position: absolute;
        top: 1320px;
        left: 0;
        width: 100%;
        font-family: "Great Vibes", cursive;
        font-size: 110px;
        font-weight: 500;
        color: #000;
    }

    .student-info {
        position: absolute;
        top: 1480px;
        left: 0;
        width: 100%;
        font-size: 48px;
        line-height: 1.4;
        color: #000;
    }

    .achievement {
        position: absolute;
        top: 1640px;
        left: 220px;
        right: 220px;
        font-size: 44px;
        line-height: 1.4;
        color: #000;
    }

    .research-title {
        position: absolute;
        top: 1840px;
        left: 220px;
        right: 220px;
        font-size: 42px;
        font-weight: bold;
    }

    .rank-badge {
        position: absolute;
        top: 2080px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 44px;
        font-weight: bold;
        color: #003366;
    }

    .rank-link {
        position: absolute;
        top: 2000px;
        width: 100%;
        font-size: 36px;
        color: #000;
    }

    .date {
        position: absolute;
        top: 2700px;
        width: 100%;
        font-size: 42px;
        font-weight: 400;
    }

    .medal {
        position: absolute;
        top: 1000px;
        left: 50%;
        transform: translateX(-50%);
        width: 240px;
        height: 240px;
    }
</style>
</head>
<body>
<h1>IARCO 2025 Certificate Generator</h1>
<div class="search-box">
    <input type="text" id="search" placeholder="Enter student name..." />
    <button id="searchBtn">Search</button>
</div>
<div class="loading" id="loading">Generating certificate, please wait...</div>
<div id="certificate"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

async function fetchJSON(path) {
    const res = await fetch(path);
    return await res.json();
}

function calculateRanksPerCategory(students) {
    const grouped = {};
    students.forEach(s => {
        const key = `${s.year}-${s.category}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(s);
    });
    Object.values(grouped).forEach(group => {
        group.sort((a,b) => b.scaledFinalScore - a.scaledFinalScore);
        group.forEach((student, index) => {
            student.rank = index + 1;
        });
    });
    return students;
}

function randomCertificateID(student) {
    const timestamp = Date.now().toString().slice(-5);
    return `${student.year}-${student.category}-${student.rank}-${timestamp}`;
}

async function loadPDFTemplate(path, container) {
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    const pdf = await pdfjsLib.getDocument(path).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 3 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    await page.render({ canvasContext: ctx, viewport }).promise;
    container.innerHTML = "";
    container.appendChild(canvas);
}

document.getElementById('searchBtn').addEventListener('click', async () => {
    const name = document.getElementById('search').value.trim().toLowerCase();
    const loading = document.getElementById('loading');
    if (!name) return alert("Enter student name.");

    loading.style.display = "block";

    const [students, flags, medals, certs] = await Promise.all([
        fetchJSON("data/finalist2024.json"),
        fetchJSON("data/flag.json"),
        fetchJSON("data/medals.json"),
        fetchJSON("data/certificate.json")
    ]);

    const rankedStudents = calculateRanksPerCategory(students);
    const student = rankedStudents.find(s => s.name.toLowerCase() === name);
    if (!student) {
        loading.style.display = "none";
        return alert("Student not found!");
    }

    const certificateContainer = document.getElementById('certificate');
    certificateContainer.style.display = "block";

    await loadPDFTemplate(certs[student.year], certificateContainer);

    const overlay = document.createElement('div');
    overlay.className = 'overlay';

    const medalType = student.rank === 1 ? 'gold' :
                      student.rank === 2 ? 'silver' :
                      student.rank === 3 ? 'bronze' :
                      student.rank <= 10 ? 'honorable' : 'finalist';

    overlay.innerHTML = `
        <img src="${medals[medalType]}" class="medal">
        <div class="student-name">${student.name}</div>
        <div class="student-info">Of<br>${student.school},<br>${student.country}</div>
        <div class="achievement">
            delivering an impressive research project and presentation,<br>
            and achieved <b>${student.rank}${ordinalSuffix(student.rank)}</b> place in the 
            <b>${student.category}</b> Category with a score of 
            <b>${student.scaledFinalScore}</b> out of 200<br>
            (Research Proposal: ${student.researchPaperScore}/100, Presentation: ${student.presentationScore}/100)
        </div>
        <div class="research-title">
            Research Title: ${student.research_proposal_title}
        </div>
        <div class="rank-link">
            https://iarco.org/${student.year}-winners?category=${student.category}&rank=${student.rank}
        </div>
        <div class="rank-badge">Top ${student.rank} out of ${rankedStudents.filter(s=>s.year===student.year && s.category===student.category).length}</div>
        <div class="date">December 30, ${student.year}</div>
    `;
    certificateContainer.appendChild(overlay);

    setTimeout(async () => {
        const canvas = await html2canvas(certificateContainer, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF("p", "px", [2480, 3508]);
        pdf.addImage(imgData, "PNG", 0, 0, 2480, 3508);
        pdf.save(`${student.name.replace(/\s+/g, '_')}_Certificate.pdf`);
        loading.style.display = "none";
    }, 2000);
});

function ordinalSuffix(i){
    const j = i % 10, k = i % 100;
    if (j == 1 && k != 11) return "st";
    if (j == 2 && k != 12) return "nd";
    if (j == 3 && k != 13) return "rd";
    return "th";
}
</script>
</body>
</html>
